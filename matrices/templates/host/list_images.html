<!--
\file         list_images.html
\author       Mike Wicks
\date         March 2021
\version      $Id$
\par
(C) University of Edinburgh, Edinburgh, UK
(C) Heriot-Watt University, Edinburgh, UK

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be
useful but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE.  See the GNU General Public License for more
details.

You should have received a copy of the GNU General Public
License along with this program; if not, write to the Free
Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
Boston, MA  02110-1301, USA.
\brief
The list images template (with Search)
-->

{% extends 'includes/base.html' %}

{% block extrastyle %}

<style>

    tr.selected {
      background-color: #ffff99 !important;
    }

    tr.active {
      background-color: #ff0000 !important;
    }

</style>

{% endblock extrastyle %}


{% load custom %}

{% load static %}

{% block breadcrumb %}

<!-- Breadcrumb Menu -->

			<li><a class="link-button btn btn-primary" href="{% url 'list_collections' %}">Collections</a></li>
			{% if allBoolean and collection_id == 0 %}
			<li><a class="link-button btn btn-primary" href="{% url 'list_images' %}">Images</a></li>
			{% else %}
			<li><a class="link-button btn btn-primary" href="{% url 'list_images' %}">Images</a></li>
			<li>Images for Collection: "{{ collection_id|stringformat:"06d" }}"</li>
			{% endif %}
			

{% endblock %}

{% block details %}

{% endblock %}

{% block content %}

<!-- Page Body -->
<div class="page-body">

<!-- Page Side Bar -->
<div class="page-sidebar">
</div><!-- End of page-sidebar -->

<!-- Page Content -->
<div class="page-content">

{% if messages %}
	{% for message in messages %}
		{% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
  <div class="panel-alert">
    <p>{{ message }}</p>
  </div>
		{% endif %}
		{% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
  <div class="panel-success">
    <p>{{ message }}</p>
  </div>
		{% endif %}
    {% endfor %}
{% endif %}

{% if allBoolean and collection_id == 0 %}
<h1>Search Images From All Your Collections</h1>
	{% if hidden_image_list|length == 0 %}
<p>You have collected {{ image_list|length }} Images from {{ collection_list|length }} Collections</p>
	{% else %}
<p>You have collected {{ image_list|length }} Images (and {{ hidden_image_list|length }} Hidden Images) from {{ collection_list|length }} Collections</p>
	{% endif %}
{% else %}
	{% if collection.id == user.profile.active_collection.id %}
<h1 class="active">Search Images from the ACTIVE Collection "{{ collection.id|stringformat:"06d" }}", "{{ collection.title }}"</h1>
		{% if collection_hidden_image_list|length == 0 %}
			{% if request.user.username == collection.owner.username %}
<p>You have collected {{ collection_image_list|length }} Images in this Collection</p>
			{% else %}
<p>"{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images (Owned By {{ collection.owner.username }}) in this Collection</p>
			{% endif %}
		{% else %}
			{% if request.user.username == collection.owner.username %}
<p>You have collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
			{% else %}
<p>"{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
			{% endif %}
		{% endif %}
	{% else %}
		{% if collection.owner == user %}
<h1 class="inactive">Search Images from the Collection "{{ collection.id|stringformat:"06d" }}", "{{ collection.title }}"</h1>
			{% if collection_hidden_image_list|length == 0 %}
				{% if request.user.username == collection.owner.username %}
<p><a href="{% url 'activate_in_collection' collection.id %}"><button class="button button-delete"><i class="fa-solid fa-bell"></i></button></a> You have collected {{ collection_image_list|length }} Images in this Collection</p>
				{% else %}
<p><a href="{% url 'activate_in_collection' collection.id %}"><button class="button button-delete"><i class="fa-solid fa-bell"></i></button></a> "{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images in this Collection</p>
				{% endif %}
			{% else %}
				{% if request.user.username == collection.owner.username %}
<p><a href="{% url 'activate_in_collection' collection.id %}"><button class="button button-delete"><i class="fa-solid fa-bell"></i></button></a> You have collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
				{% else %}
<p><a href="{% url 'activate_in_collection' collection.id %}"><button class="button button-delete"><i class="fa-solid fa-bell"></i></button></a> "{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
				{% endif %}
			{% endif %}
		{% else %}
<h1 class="inactive">Collection {{ collection.id|stringformat:"06d" }}, "{{ collection.title }}"</h1>
			{% if collection_hidden_image_list|length == 0 %}
				{% if request.user.username == collection.owner.username %}
<p>You have collected {{ collection_image_list|length }} Images in this Collection</p>
				{% else %}
<p>"{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images in this Collection</p>
				{% endif %}
			{% else %}
				{% if request.user.username == collection.owner.username %}
<p>You have collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
				{% else %}
<p>"{{ collection.owner.username }}" has collected {{ collection_image_list|length }} Images (and {{ collection_hidden_image_list|length }} Hidden Images) in this Collection</p>
				{% endif %}
			{% endif %}
		{% endif %}
	{% endif %}
{% endif %}

{% if allBoolean %}
<form action="{% url 'list_images' %}" method="get">
{% else %}
<form action="{% url 'list_images' collection_id %}" method="get">
{% endif %}
{% include 'includes/form_search_images.html' %}
<br />
  <button class="button button-add" type="submit">Search</button>
  <button class="button button-delete" onclick="clearForm(this.form);" >Clear</button>
</form>
<br />
<hr>
<br />

{% if image_summary_list %}
	{% for image_summary in image_summary_list %}
		{% if forloop.first %}
<table border=0>
  <tr>
    <th>Action</th>
{% include 'includes/sort_links_table_headings.html' %}
  </tr>
  <tr>
    <td colspan="9"  style="border-bottom:2px solid Black;">&nbsp;</td>
  </tr>
		{% endif %}
  <tr id="image_summary-{{image_summary.image_id}}-A">
	{% if readBoolean %}
    <td>
        <div class="generic-dropdown">
            <button class="generic-drop-button btn button button-add"><i class="fas fa-bars"></i></button>
            <div class="generic-dropdown-content">
        {% if image_summary.is_wordpress %}
              <a class="link-button btn btn-primary" href="{% url 'webgallery_show_wordpress_image' image_summary.image_server_id image_summary.image_identifier %}"><i class="fa fa-info"></i> Image Info.</a>
        {% endif %}
        {% if image_summary.is_omero547 %}
              <a class="link-button btn btn-primary" href="{% url 'webgallery_show_image' image_summary.image_server_id image_summary.image_identifier %}"><i class="fa fa-info"></i> Image Info.</a>
        {% endif %}
        {% if image_summary.is_ebi_sca %}
              <a class="link-button btn btn-primary" href="{% url 'webgallery_show_ebi_sca_image' image_summary.image_server_id image_summary.image_name %}"><i class="fa fa-info"></i> Image Info.</a>
        {% endif %}
        {% if image_summary.is_cpw %}
              <a class="link-button btn btn-primary" href="{% url 'webgallery_show_cpw_image' image_summary.image_server_id image_summary.image_name %}"><i class="fa fa-info"></i> Image Info.</a>
        {% endif %}
		{% if image_summary.image_owner == user.username or user.username == 'admin' %}
				<a class="link-button btn btn-primary" href="{% url 'webgallery_delete_collection_image' image_summary.image_collection_id image_summary.image_id %}" onclick="return confirm('Are you sure you want to DELETE this IMAGE?')"><i class="fa fa-trash"></i> Delete</a>
		{% endif %}

		{% if image_summary.exists_parent_image_links or image_summary.exists_child_image_links %}
				<a class="link-button btn btn-primary" href="{% url 'view_a_and_b_image_links' image_summary.image_id %}"><i class="fa fa-chain"></i> Links</a>
		{% endif %}

                <a class="link-button btn btn-primary" href="{% url 'list_images' image_summary.image_collection_id %}"><i class="fa fa-eye"></i> View Collection "{{ image_summary.image_collection_id|stringformat:"06d" }}"</a>

        {% if image_summary.image_matrix_id != 0 %}
                <a class="link-button btn btn-primary" href="{% url 'matrix' image_summary.image_matrix_id %}"><i class="fa fa-eye"></i> View Bench: "CPW:{{ image_summary.image_matrix_id|stringformat:"06d" }}"</a>
    	{% endif %}

            </div><!-- End of generic-dropdown-content -->
        </div><!-- End of generic-dropdown -->
    </td>
	{% else %}
    <td>&nbsp;</td>
	{% endif %}
		
	<td colspan="2" rowspan="7">
	{% if image_summary.is_accessible %}
		{% if request.get_host == 'localhost:8000' %}
		<div id="I_{{ image_summary.image_id }}_{{ image_summary.image_server_uid }}@{{ image_summary.image_server_url_server }}" class="loginStatus_out">
			<a href="https://{{ image_summary.image_server_url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'list_images' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		</div>
		<div id="O_{{ image_summary.image_id }}_{{ image_summary.image_server_uid }}@{{ image_summary.image_server_url_server }}" class="loginStatus_in">
			<a href="{{ image_summary.image_viewer_url }}" target="_blank"><img id="image_{{ image_summary.image_id }}" alt="{{ image_summary.image_name }}" style="width:256px; height:256px; float: left" title="{{ image_summary.image_name }}" class="image-holder" src="{{ image_summary.image_birdseye_url }}"> </a>
		</div>
		{% else %}
		<div id="I_{{ image_summary.image_id }}_{{ image_summary.image_server_uid }}@{{ image_summary.image_server_url_server }}" class="loginStatus_out">
			<a href="https://{{ image_summary.image_server_url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'list_images' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		</div>
		<div id="O_{{ image_summary.image_id }}_{{ image_summary.image_server_uid }}@{{ image_summary.image_server_url_server }}" class="loginStatus_in">
			<a href="{{ image_summary.image_viewer_url }}" target="_blank"><img id="image_{{ image_summary.image_id }}" alt="{{ image_summary.image_name }}" style="width:256px; height:256px; float: left" title="{{ image_summary.image_name }}" class="image-holder" src="{{ image_summary.image_birdseye_url }}"> </a>
		</div>
		{% endif %}
	{% else %}
		<a href="{{ image_summary.image_viewer_url  }}" target="_blank"><img alt="{{ image_summary.image_name }}" title="{{ image_summary.image_name }}" style="width:256px; height:256px; float: left" title="{{ image_summary.image_name }}" src="{{ image_summary.image_birdseye_url }}" ></a>
	{% endif %}
    </td>
	<td><strong>Name:</strong></td>
	<td colspan="7">{{ image_summary.image_name }}</td>
</tr>

<tr id="image_summary-{{image_summary.image_id}}-B">
    <td colspan="1">&nbsp;</td>
	{% if image_summary.image_comment == '' %}
	<td><strong>Comment:</strong></td>
	<td colspan="7">No Comments</td>
	{% else %}
	<td><strong>Comment:</strong></td>
	<td colspan="7">{{ image_summary.image_comment }}</td>
	{% endif %}
  </tr>

<tr id="image_summary-{{image_summary.image_id}}-C">
	<td colspan="1">&nbsp;</td>
	<td><strong>ROI:</strong></td>
	<td colspan="2">{{ image_summary.image_roi }}</td>
	<td><strong>Server:</strong></td>
	<td colspan="2">{{ image_summary.image_server }}</td>
  </tr>

  <tr id="image_summary-{{image_summary.image_id}}-D">
    <td colspan="1">&nbsp;</td>
	<td><strong>Hidden:</strong></td>
	<td colspan="2">{{ image_summary.image_hidden }}</td>
	<td><strong>Collection:</strong></td>
	<td colspan="2">"{{ image_summary.image_collection_id|stringformat:"06d" }}"; "{{ image_summary.image_collection_title }}"; (Owned By {{ image_summary.image_collection_owner }}) <a href="{% url 'list_images' image_summary.image_collection_id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a></td>
  </tr>

  <tr id="image_summary-{{image_summary.image_id}}-E">
    <td colspan="1">&nbsp;</td>
	<td><strong>Owner:</strong></td>
	<td colspan="2">{{ image_summary.image_owner }}</td>
	<td><strong>Bench:</strong></td>
    {% if image_summary.image_matrix_id == 0 %}
	<td colspan="2">Image NOT Used in a Bench!</td>
	{% else %}
	<td colspan="2">"CPW:{{ image_summary.image_matrix_id|stringformat:"06d" }}"; "{{ image_summary.image_matrix_title }}"; (Owned By {{ image_summary.image_matrix_owner }}) <a href="{% url 'matrix' image_summary.image_matrix_id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a></td>
	{% endif %}
  </tr>

  <tr id="image_summary-{{image_summary.image_id}}-F">
    <td colspan="9">&nbsp;</td>
  </tr>
  <tr id="image_summary-{{image_summary.image_id}}-G">
    <td colspan="10">&nbsp;</td>
  </tr>
  <tr id="image_summary-{{image_summary.image_id}}-H">
    <td colspan="10" style="border-bottom:2px solid Black;">&nbsp;</td>
  </tr>
		{% if forloop.last %}
</table>
		{% endif %}
	{% endfor %}
{% include 'includes/pagination.html' %}
{% else %}
<p>No Images are available.</p>
{% endif %}

</div><!-- End of page-content -->

</div><!-- End of page-body -->

<script>

	function clearForm(oForm) {

		var elements = oForm.elements;

		oForm.reset();

		for(i=0; i<elements.length; i++) {

			field_type = elements[i].type.toLowerCase();

			switch(field_type) {

				case "text":
				case "password":
				case "textarea":
		    	case "hidden":
					elements[i].value = "";
					break;

				case "radio":
				case "checkbox":
	  				if (elements[i].checked) {
	   					elements[i].checked = false;
					}
					break;

				case "select-one":
				case "select-multi":
	            	elements[i].selectedIndex = -1;
					break;

				default:
					break;
			}
		}
	}

</script>

{% endblock %}

{% block extrajs %}
<script language="javascript">

	// FUNCTION
	async function makeJSONRequest(method, url, data) {

	    const options = {
	        method: method, // *GET, POST, PUT, DELETE, etc.
	        credentials: 'include', // include, *same-origin, omit
	    }

	    if (method == 'POST') {

	        const csrf_token = getCookie('csrftoken');

	        options.headers = {
	            'x-csrftoken': csrf_token
	        }
	    }

	    if (data) {

	        options.body = data;
	    }

	    // Do the fetch and check status...
	    const response = await fetch(url, options);

	    if (response.status != 200) {

	        throw response;
	    }

	    // If OK, parse JSON response into native JavaScript objects
	    return response.json();
	}


	// FUNCTION
	function getCookie(name) {

	    var cookieValue = null;

	    if (document.cookie && document.cookie != '') {

	        var cookies = document.cookie.split(';');

	        for (var i = 0; i < cookies.length; i++) {

	            var cookie = cookies[i].trim();



	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {

	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}


	// FUNCTION
	function getParameterByName(name, url = window.location.href) {

	    name = name.replace(/[\[\]]/g, '\\$&');

	    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
	        results = regex.exec(url);

	    if (!results) return null;

	    if (!results[2]) return '';

	    return decodeURIComponent(results[2].replace(/\+/g, ' '));
	}


	// FUNCTION
	async function loginStatusPresent(divname) {

	    var projects_url = getUrl('url:projects');

	    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

			console.log("loginStatusPresent : " + divname + " ; display" );
			document.getElementById(divname).style.display = 'display';

	    }).catch(rsp => {

			console.log("loginStatusPresent : " + divname + " ; none" );
			document.getElementById(divname).style.display = 'none';
	    });

	}


	// FUNCTION
	async function loginStatusAbsent(divname) {

	    var projects_url = getUrl('url:projects');

	    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

			console.log("loginStatusAbsent : " + divname + " ; none" );
		    document.getElementById(divname).style.display = 'none';

	    }).catch(rsp => {

			console.log("loginStatusAbsent : " + divname + " ; display" );
			document.getElementById(divname).style.display = 'display';
	    });

	}


	// FUNCTION
	async function server_present(server_url, divname) {

	    // List of supported versions
	    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

	    // Get base_url from last version in the list
	    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
	    latest_base_url = versions[versions.length - 1]["url:base"]

	    // Get the list of top-level urls as starting points,
	    base_urls = await makeJSONRequest('GET', latest_base_url);

	    // Also get CSRF token needed for any POST requests (login, logout etc)
	    // Header of this response sets a cookie. NB: We can ingore the response JSON
	    await makeJSONRequest('GET', getUrl('url:token'));

	    // Try to load Projects (will show Login form if we're not logged in)
	    loginStatusPresent(divname);
	}


	// FUNCTION
	async function server_absent(server_url, divname) {

	    // List of supported versions
	    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

	    // Get base_url from last version in the list
	    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
	    latest_base_url = versions[versions.length - 1]["url:base"]

	    // Get the list of top-level urls as starting points,
	    base_urls = await makeJSONRequest('GET', latest_base_url);

	    // Also get CSRF token needed for any POST requests (login, logout etc)
	    // Header of this response sets a cookie. NB: We can ingore the response JSON
	    await makeJSONRequest('GET', getUrl('url:token'));

	    // Try to load Projects (will show Login form if we're not logged in)
	    loginStatusAbsent(divname);
	}


	// FUNCTION
	function getUrl(name) {

	    return base_urls[name];
	}


	// MAINLINE

	// When page first loads, if we have a server...
	//const server_url = getParameterByName("server");

	collection_in = document.getElementsByClassName("loginStatus_in");

	for (var i = 0; i < collection_in.length; i++) {

		nodeHTML = collection_in[i];
		text = nodeHTML.id;
		//console.log("IN text : " + text);
		myArray = text.split("@");
		server_url = 'https://' + myArray[1] + '/';

		server_present(server_url, nodeHTML.id);
	}

	collection_out = document.getElementsByClassName("loginStatus_out");

	for (var i = 0; i < collection_out.length; i++) {

		nodeHTML = collection_out[i]
		text = nodeHTML.id;
		//console.log("OUT text : " + text);
		myArray = text.split("@");
		server_url = 'https://' + myArray[1] + '/';

		server_absent(server_url, nodeHTML.id);
	}

</script>

{% endblock extrajs %}
