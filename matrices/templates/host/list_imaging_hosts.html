<!--
\file         list_imaging_hosts.html
\author       Mike Wicks
\date         March 2021
\version      $Id$
\par
(C) University of Edinburgh, Edinburgh, UK
(C) Heriot-Watt University, Edinburgh, UK

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be
useful but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE.  See the GNU General Public License for more
details.

You should have received a copy of the GNU General Public
License along with this program; if not, write to the Free
Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
Boston, MA  02110-1301, USA.
\brief
The list imaging hosts (Servers) template
-->

{% extends 'includes/base.html' %}

{% load custom %}

{% load static %}

{% block breadcrumb %}

<!-- Breadcrumb Menu -->

			<li>Sources</li>

{% endblock %}

{% block details %}

{% endblock %}

{% block content %}

<!-- Page Body -->
<div class="page-body">

<!-- Page Side Bar -->
<div class="page-sidebar">
</div><!-- End of page-sidebar -->

<!-- Page Content -->
<div class="page-content">

	<h1>Search Sources</h1>

	<p>Search the sources with a URL (OMERO and EBI SCA sources ONLY!):</p>

	<form action="{% url 'search_image' search_from 0 %}" method="post">

		{% csrf_token %}

		{% include 'includes/form.html' %}

	</form>

	<br />
	<hr>
	<br />

{% if server_list %}

	{% for server in server_list %}

		{% if forloop.first %}

    <table border="0">
	    <tr>
			<th width="50px"></th>
			<th width="200px">Action</th>
        	<th width="150px">Owner</th>
            <th>Name</th>
	        <th>URL</th>
    	    <th>Type</th>
		</tr>
	    <tr>
    	    <td>&nbsp;</td>
        	<td>&nbsp;</td>
			<td>&nbsp;</td>
            <td>&nbsp;</td>
	        <td>&nbsp;</td>
    	    <td>&nbsp;</td>
		</tr>

		{% endif %}

        <tr>

		{% if credential_flag %}

			{% if user.id == server.owner.id or user.is_superuser %}

			<td>

				{% if server.is_accessible %}

					{% if request.get_host == 'localhost:8000' %}

				<div id="I_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_out">
					<a href="https://{{ server.url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'list_imaging_hosts' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
				</div>
				<div id="O_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_in">
				</div>

					{% else %}

				<div id="I_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_out">
					<a href="https://{{ server.url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'list_imaging_hosts' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
				</div>
				<div id="O_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_in">
				</div>

					{% endif %}

				{% endif %}

			</td>
			<td>

				{% if server.type.name == 'WORDPRESS' %}

				<a href="{% url 'webgallery_show_wordpress' server.id 1 %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				{% if server.type.name == 'OMERO_5.4.7' or server.type.name == 'OMERO_5.6' %}

				<a href="{% url 'webgallery_show_imaging_server' server.id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				{% if server.type.name == 'EBI_SCA' %}

				<a href="{% url 'webgallery_show_ebi_sca_server' server.id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				<a href="{% url 'detail_server' server.id %}"><button class="button button-info"><i class="fa fa-info"></i></button></a>
				<a href="{% url 'edit_server' server.id %}"><button class="save button button-edit"><i class="fa fa-edit"></i></button></a>
				<a href="{% url 'delete_server' server.id %}" onclick="return confirm('Are you sure you want to DELETE this Image Server?')"><button class="button button-delete"><i class="fa fa-trash"></i></button></a>
	        </td>


			{% else %}

			<td>

				{% if server.is_accessible %}

					{% if request.get_host == 'localhost:8000' %}

				<div id="I_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_out">
					<a href="https://{{ server.url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'list_imaging_hosts' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
				</div>
				<div id="O_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_in">
				</div>

					{% else %}

				<div id="I_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_out">
					<a href="https://{{ server.url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'list_imaging_hosts' %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
				</div>
				<div id="O_{{ server.id }}_{{ server.uid }}@{{ server.url_server }}" class="loginStatus_in">
				</div>

					{% endif %}

				{% endif %}

			</td>
			<td>

				{% if server.type.name == 'WORDPRESS' %}

				<a href="{% url 'webgallery_show_wordpress' server.id 1 %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				{% if server.type.name == 'OMERO_5.4.7' or server.type.name == 'OMERO_5.6' %}

				<a href="{% url 'webgallery_show_imaging_server' server.id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				{% if server.type.name == 'EBI_SCA' %}

				<a href="{% url 'webgallery_show_ebi_sca_server' server.id %}"><button class="button button-view"><i class="fa fa-eye"></i></button></a>

				{% endif %}

				<a href="{% url 'detail_server' server.id %}"><button class="button button-info"><i class="fa fa-info"></i></button></a>

            </td>

			{% endif %}

		{% else %}

	        <td>&nbsp;</td>

		{% endif %}

    	    <td>{{ server.owner.username }}</td>
        	<td>{{ server.name }}</td>
            <td>{{ server.url_server }}</td>
	        <td>{{ server.type.name }}</td>
		</tr>

		{% if forloop.last %}

        <tr>

			{% if user.is_superuser %}

	    	<td><a href="{% url 'new_server' %}"><button class="button button-add"><i class="fa fa-plus"></i></button></a></td>

			{% else %}

	    	<td>&nbsp;</td>

			{% endif %}

	        <td>&nbsp;</td>
	        <td>&nbsp;</td>
		    <td>&nbsp;</td>
			<td>&nbsp;</td>
	    	<td>&nbsp;</td>
		</tr>

	</table>

		{% endif %}

	{% endfor %}

{% else %}

	<p>No Sources are available.</p>

{% endif %}

</div><!-- End of page-content -->

</div><!-- End of page-body -->


<script type="text/javascript">

// FUNCTION
async function makeJSONRequest(method, url, data) {

    const options = {
        method: method, // *GET, POST, PUT, DELETE, etc.
        credentials: 'include', // include, *same-origin, omit
    }

    if (method == 'POST') {

        const csrf_token = getCookie('csrftoken');

        options.headers = {
            'x-csrftoken': csrf_token
        }
    }

    if (data) {

        options.body = data;
    }

    // Do the fetch and check status...
    const response = await fetch(url, options);

    if (response.status != 200) {

        throw response;
    }

    // If OK, parse JSON response into native JavaScript objects
    return response.json();
}


// FUNCTION
function getCookie(name) {

    var cookieValue = null;

    if (document.cookie && document.cookie != '') {

        var cookies = document.cookie.split(';');

        for (var i = 0; i < cookies.length; i++) {

            var cookie = cookies[i].trim();

            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {

                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


// FUNCTION
function getParameterByName(name, url = window.location.href) {

    name = name.replace(/[\[\]]/g, '\\$&');

    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);

    if (!results) return null;

    if (!results[2]) return '';

    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}


// FUNCTION
async function loginStatusPresent(divname) {

    var projects_url = getUrl('url:projects');

    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

	    document.getElementById(divname).style.display = 'display';

    }).catch(rsp => {

		document.getElementById(divname).style.display = 'none';
    });

}


// FUNCTION
async function loginStatusAbsent(divname) {

    var projects_url = getUrl('url:projects');

    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

	    document.getElementById(divname).style.display = 'none';

    }).catch(rsp => {

		document.getElementById(divname).style.display = 'display';
    });

}


// FUNCTION
async function server_present(server_url, divname) {

    // List of supported versions
    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

    // Get base_url from last version in the list
    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
    latest_base_url = versions[versions.length - 1]["url:base"]

    // Get the list of top-level urls as starting points,
    base_urls = await makeJSONRequest('GET', latest_base_url);

    // Also get CSRF token needed for any POST requests (login, logout etc)
    // Header of this response sets a cookie. NB: We can ingore the response JSON
    await makeJSONRequest('GET', getUrl('url:token'));

    // Try to load Projects (will show Login form if we're not logged in)
    loginStatusPresent(divname);
}


// FUNCTION
async function server_absent(server_url, divname) {

    // List of supported versions
    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

    // Get base_url from last version in the list
    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
    latest_base_url = versions[versions.length - 1]["url:base"]

    // Get the list of top-level urls as starting points,
    base_urls = await makeJSONRequest('GET', latest_base_url);

    // Also get CSRF token needed for any POST requests (login, logout etc)
    // Header of this response sets a cookie. NB: We can ingore the response JSON
    await makeJSONRequest('GET', getUrl('url:token'));

    // Try to load Projects (will show Login form if we're not logged in)
    loginStatusAbsent(divname);
}


// FUNCTION
function getUrl(name) {

    return base_urls[name];
}


// MAINLINE

// When page first loads, if we have a server...
//const server_url = getParameterByName("server");

collection_in = document.getElementsByClassName("loginStatus_in");

for (var i = 0; i < collection_in.length; i++) {

	nodeHTML = collection_in[i];
	text = nodeHTML.id;
	console.log("IN text : " + text);
	myArray = text.split("@");
	server_url = 'https://' + myArray[1] + '/';

	server_present(server_url, nodeHTML.id);
}

collection_out = document.getElementsByClassName("loginStatus_out");

for (var i = 0; i < collection_out.length; i++) {

	nodeHTML = collection_out[i]
	text = nodeHTML.id;
	console.log("OUT text : " + text);
	myArray = text.split("@");
	server_url = 'https://' + myArray[1] + '/';

	server_absent(server_url, nodeHTML.id);
}

</script>

{% endblock %}
