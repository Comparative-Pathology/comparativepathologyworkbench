<!--
\file         view_matrix.html
\author       Mike Wicks
\date         March 2021
\version      $Id$
\par
(C) University of Edinburgh, Edinburgh, UK
(C) Heriot-Watt University, Edinburgh, UK

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be
useful but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE.  See the GNU General Public License for more
details.

You should have received a copy of the GNU General Public
License along with this program; if not, write to the Free
Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
Boston, MA  02110-1301, USA.
\brief
The view matrix (bench) template
-->

{% extends 'includes/base.html' %}

{% load custom %}

{% load static %}

{% load inlineedit %}

{% block extrastyle %}

<style>

</style>

{% endblock extrastyle %}

{% block breadcrumb %}
<!-- Breadcrumb Menu -->
			<li>
				<a href="{% url 'list_benches' %}">Workbenches</a>
			</li>
			<li>
				<a data-value="{{ matrix.id }}" href="#" class="bench-info-button btn btn-primary">CPW:{{ matrix.id|stringformat:"06d" }}, {{ matrix.title }}</a>
			</li>
			<li>
				<a href="{% url 'aggregated_matrix_blog' matrix.id %}">
				  <div class="tooltip" style="font-size: 12px; width:150px;">
	{% if settings.LOCATION == 'CZI' %}
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #E3F2FD; border-radius: 5px; color: Black; background-color: #E3F2FD; font-size: 1em;">
	{% endif %}
	{% if settings.LOCATION == 'CANADA' %}
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #F5776E; border-radius: 5px; color: Black; background-color: #F5776E; font-size: 1em;">
	{% endif %}
	{% if settings.LOCATION == 'COELIAC' %}
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #FCBA03; border-radius: 5px; color: Black; background-color: #FCBA03; font-size: 1em;">
	{% endif %}
						<i class="fa fa-bullhorn"></i>
					</button>
		            <span class="tooltiptext">Aggregated Bench and Cell Commentary</span>
		    	  </div>
				</a>
			</li>

			
	{% if settings.LOCATION == 'CZI' %}
			<li style="float: right;">
				<a href="{% url 'matrix' next_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #E3F2FD; border-radius: 5px; color: Black; background-color: #E3F2FD; font-size: 1em;"><i class="fa fa-arrow-right"></i> Next</button>
				</a>
			</li>
			<li style="float: right;">
				<a href="{% url 'matrix' previous_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #E3F2FD; border-radius: 5px; color: Black; background-color: #E3F2FD; font-size: 1em;"><i class="fa fa-arrow-left"></i> Previous</button>
				</a>
			</li>
    {% endif %}
    {% if settings.LOCATION == 'CANADA' %}
			<li style="float: right;">
				<a href="{% url 'matrix' next_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #F5776E; border-radius: 5px; color: Black; background-color: #F5776E; font-size: 1em;"><i class="fa fa-arrow-right"></i> Next</button>
				</a>
			</li>
			<li style="float: right;">
				<a href="{% url 'matrix' previous_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #F5776E; border-radius: 5px; color: Black; background-color: #F5776E; font-size: 1em;"><i class="fa fa-arrow-left"></i> Previous</button>
				</a>
			</li>
    {% endif %}
    {% if settings.LOCATION == 'COELIAC' %}
			<li style="float: right;">
				<a href="{% url 'matrix' next_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #FCBA03; border-radius: 5px; color: Black; background-color: #FCBA03; font-size: 1em;"><i class="fa fa-arrow-right"></i> Next</button>
				</a>
			</li>
			<li style="float: right;">
				<a href="{% url 'matrix' previous_bench %}">
					<button class="button button-add" style="text-align: center; text-decoration: none; border: 1px solid; border-color: #FCBA03; border-radius: 5px; color: Black; background-color: #FCBA03; font-size: 1em;"><i class="fa fa-arrow-left"></i> Previous</button>
				</a>
			</li>
    {% endif %}
{% endblock %}

{% block content %}
<!-- Main Data Panel -->
<div class="page-body">
<div class="page-sidebar" style="overflow-y: scroll;">
{% if readBoolean %}
{% else %}
{% endif %}
{% if updateBoolean %}
<!-- Selected or Active Image Collection -->
  <div class="collection-container">
	<div class="collection-item">
	  <div class="collection-master">
		<div class="collection-master-control">
		  <div class="collection-dropdown">
			<button class="collection-drop-button"><i class="fas fa-bars"></i></button>
			<div class="collection-dropdown-content">
				<a class="test-font" href="{% url 'bench_collection_update' matrix.id %}" onclick="open_matrix_edit_dialog(event, 'Select Collection for Bench CPW:{{ matrix.id|stringformat:"06d" }} ...'); return false;"><button class="button-mini button-add"><i class="fa fa-edit"></i></button> Select Collection</a>
    {% if collection_list %}
        {% for collection in collection_list %}
            {% if matrix.has_last_used_collection == True %}
	            {% if matrix.last_used_collection.id == collection.collection_id %}
				<a class="test-font" title="({{ collection.collection_owner }}), {{ collection.collection_title }}" href="{% url 'view_collection' matrix.last_used_collection.id %}"><button class="button-mini button-view"><i class="fa fa-eye"></i></button> View Collection</a>
		        {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
			</div>
		  </div>
		</div>
	  </div>
	</div>
    {% if collection_image_list %}
        {% for image in collection_image_list %}
		  	{% if updateBoolean %}
	<div class="collection-item" draggable="true" ondragstart="drag(event)" id="image_{{ image.id }}">
	  <div class="collection-image">
	  			{% csrf_token %}
			{% else %}
	<div class="collection-item" id="image_{{ image.id }}">
	  <div class="collection-image">
	        {% endif %}
			{% if image.server.is_accessible %}
				{% if request.get_host == 'localhost:8000' %}
		<div id="I_{{ image.id }}_{{ image.server.uid }}@{{ image.server.url_server }}" class="loginStatus_out">
			<a href="https://{{ image.server.url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		</div>
		<div id="O_{{ image.id }}_{{ image.server.uid }}@{{ image.server.url_server }}" class="loginStatus_in">
			<a href="{{ image.viewer_url }}" target="_blank"><img id="image_{{ image.id }}" alt="{{ image.name }}" title="{{ image.name }}" class="image-holder" src="{{ image.birdseye_url }}" draggable="true" ondragstart="drag(event)"> </a>
		</div>
				{% else %}
		<div id="I_{{ image.id }}_{{ image.server.uid }}@{{ image.server.url_server }}" class="loginStatus_out">
			<a href="https://{{ image.server.url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		</div>
		<div id="O_{{ image.id }}_{{ image.server.uid }}@{{ image.server.url_server }}" class="loginStatus_in">
			<a href="{{ image.viewer_url }}" target="_blank"><img id="image_{{ image.id }}" alt="{{ image.name }}" title="{{ image.name }}" class="image-holder" src="{{ image.birdseye_url }}" draggable="true" ondragstart="drag(event)"> </a>
		</div>
				{% endif %}
			{% else %}
		<a href="{{ image.viewer_url }}" target="_blank"><img id="image_{{ image.id }}" alt="{{ image.name }}" title="{{ image.name }}" class="image-holder" src="{{ image.birdseye_url }}" draggable="true" ondragstart="drag(event)"> </a>
			{% endif %}
	  </div>
	</div>
        {% endfor %}
    {% else %}
        {% if matrix.has_last_used_collection == True %}
	<div class="collection-item">
	  <div class="collection-image">
		<button class="basket-button button-info"><i class="fa fa-eye-slash"></i></button>
	  </div>
	</div>
        {% endif %}
    {% endif %}
  </div>
{% endif %}
</div>

<!-- The Bench -->
<div class="page-content">
{% if messages %}
	{% for message in messages %}
		{% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
		<div class="panel-alert">
			<p>{{ message }}</p>
		</div>
		{% endif %}
		{% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
		<div class="panel-success">
			<p>{{ message }}</p>
		</div>
		{% endif %}
    {% endfor %}
{% endif %}

{% if rows %}
    {% for row in rows %}
  <div class="flex-bench-container">
        {% for column in columns %}
		    {% with matrix_cell=matrix_cells|index:forloop.parentloop.counter0|index:forloop.counter0 %}
		        {% if matrix_cell.is_master %}
    <div class="flex-bench-item" id="{{ matrix_cell.id }}">
      <div class="master-cell">
        <div class="master-cell-control">
          <div class="bench-dropdown">
            <button class="bench-drop-button"><i class="fas fa-bars"></i></button>
            <div class="bench-dropdown-content">
					{% if readBoolean %}
			  <a data-value="{{ matrix.id }}" href="#" class="bench-info-button btn btn-primary"><i class="fa fa-info"></i> Info.</a>
			  <a data-value="{{ matrix.id }}" href="#" class="bench-blog-button btn btn-primary"><i class="fa fa-eye"></i> View Bench Commentary</a>
			  <a href="{% url 'aggregated_matrix_blog' matrix.id %}"><i class="fa fa-bullhorn"></i><span class="menu-item">&#9;</span> Aggregated Commentary</a>
						{% if updateBoolean %}
			  <a href="{% url 'bench_update' matrix.id %}" onclick="open_matrix_edit_dialog(event, 'Updating Bench CPW:{{ matrix.id|stringformat:"06d" }} ...'); return false;"><i class="fa fa-edit"></i> Edit</a>
			  <a href="{% url 'detail_matrix_blog' matrix.id %}" target="_blank"><i class="fa fa-edit"></i><span class="menu-item">&#9;</span>Edit Bench Commentary</a>
			  <a href="{% url 'bench_delete' matrix.id %}" onclick="delete_matrix(event, 'Deleting Bench CPW:{{ matrix.id|stringformat:"06d" }}'); return false;"><i class="fa fa-trash"></i> Delete</a>
			  <a href="{% url 'append_column' matrix.id %}"><i class="fa fa-angle-double-right"></i><span class="menu-item">&#9;</span>APPEND Column</a>
			  <a href="{% url 'delete_last_column' matrix.id %}" onclick="return confirm('Are you sure you want to DELETE the last COLUMN?')"><i class="fa fa-angle-double-left"></i><span class="menu-item">&#9;</span>Delete LAST Column</a>
			  <a href="{% url 'append_row' matrix.id %}"><i class="fa fa-angle-double-down"></i><span class="menu-item">&#9;</span>APPEND Row</a>
			  <a href="{% url 'delete_last_row' matrix.id %}" onclick="return confirm('Are you sure you want to DELETE the last ROW?')"><i class="fa fa-angle-double-up"></i><span class="menu-item">&#9;</span>Delete LAST Row</a>
			        	{% endif %}
					{% endif %}
            </div><!-- End of bench-dropdown-content -->
          </div><!-- End of bench-dropdown -->
        </div><!-- End of master-cell-control -->
      </div><!-- End of master-cell -->
    </div><!-- End of flex-bench-item -->
	    	    {% endif %}
<!-- Row Header Cells -->
		        {% if matrix_cell.is_column_header and not matrix_cell.is_row_header %}
<!-- The Bottom-Most Row Header Cell -->
			        {% if matrix.get_max_row == matrix_cell.ycoordinate %}
    <div class="flex-bench-item" id="BMRHC_{{ matrix_cell.id }}">
						{% csrf_token %}
      <div class="bottom-right-cell" id="BMRHC_{{ matrix_cell.id }}" ondrop="dropRow(event)" ondragover="allowRowDrop(event)">
      </div><!-- End of bottom-right-cell -->
    </div><!-- End of flex-bench-item -->
    			    {% endif %}
<!-- The Other Row Header Cells -->
				    {% if matrix.get_max_row != matrix_cell.ycoordinate %}
      <div class="flex-bench-item" id="ORHC_{{ matrix_cell.id }}" draggable="true" ondragstart="drag(event)">
  						{% csrf_token %}
      <div class="row-header-cell" style="height:{{ matrix.height }}px;" id="ORHC_{{ matrix_cell.id }}" ondrop="dropRow(event)" ondragover="allowRowDrop(event)">
		<div class="row-header-cell-title" id="ORHC_{{ matrix_cell.id }}" style="top: 27px;" draggable="true" ondragstart="drag(event)" >
                        {% if matrix_cell.title != '' %}
          <div class="tooltiprow"><i class="fa fa-info-circle"></i>
              <span class="tooltiprowtext" style="margin-left: 22px;">{{ matrix_cell.title }}</span>
          </div>
        </div><!-- End of row-header-cell-title -->
        <div class="vertical-text" style="margin-top: {{ matrix.height|add:"-22" }}px; margin-left: 7px; width:{{ matrix.height|add:"-102" }}px;">
                            {% if matrix.height >= 75 and matrix.height <= 93 %}
                            {% endif %}
                            {% if matrix.height >= 94 and matrix.height <= 112 %}
            {{ matrix_cell.title|truncatechars:1 }}
                            {% endif %}
                            {% if matrix.height >= 113 and matrix.height <= 131 %}
            {{ matrix_cell.title|truncatechars:3 }}
                            {% endif %}
                            {% if matrix.height >= 132 and matrix.height <= 150 %}
            {{ matrix_cell.title|truncatechars:5 }}
                            {% endif %}
                            {% if matrix.height >= 151 and matrix.height <= 169 %}
            {{ matrix_cell.title|truncatechars:6 }}
                            {% endif %}
                            {% if matrix.height >= 170 and matrix.height <= 188 %}
            {{ matrix_cell.title|truncatechars:6 }}
                            {% endif %}
                            {% if matrix.height >= 189 and matrix.height <= 208 %}
            {{ matrix_cell.title|truncatechars:9 }}
                            {% endif %}
                            {% if matrix.height >= 209 and matrix.height <= 227 %}
            {{ matrix_cell.title|truncatechars:11 }}
                            {% endif %}
                            {% if matrix.height >= 228 and matrix.height <= 246 %}
            {{ matrix_cell.title|truncatechars:13 }}
                            {% endif %}
                            {% if matrix.height >= 247 and matrix.height <= 265 %}
            {{ matrix_cell.title|truncatechars:15 }}
                            {% endif %}
                            {% if matrix.height >= 266 and matrix.height <= 284 %}
            {{ matrix_cell.title|truncatechars:18 }}
                            {% endif %}
                            {% if matrix.height >= 285 and matrix.height <= 303 %}
            {{ matrix_cell.title|truncatechars:21 }}
                            {% endif %}
                            {% if matrix.height >= 304 and matrix.height <= 322 %}
            {{ matrix_cell.title|truncatechars:23 }}
                            {% endif %}
                            {% if matrix.height >= 323 and matrix.height <= 341 %}
            {{ matrix_cell.title|truncatechars:25 }}
                            {% endif %}
                            {% if matrix.height >= 342 and matrix.height <= 360 %}
            {{ matrix_cell.title|truncatechars:27 }}
                            {% endif %}
                            {% if matrix.height >= 361 and matrix.height <= 379 %}
            {{ matrix_cell.title|truncatechars:29 }}
                            {% endif %}
                            {% if matrix.height >= 380 and matrix.height <= 398 %}
            {{ matrix_cell.title|truncatechars:31 }}
                            {% endif %}
                            {% if matrix.height >= 399 and matrix.height <= 407 %}
            {{ matrix_cell.title|truncatechars:33 }}
                            {% endif %}
                            {% if matrix.height >= 408 and matrix.height <= 426 %}
            {{ matrix_cell.title|truncatechars:35 }}
                            {% endif %}
                            {% if matrix.height >= 427 and matrix.height <= 450 %}
            {{ matrix_cell.title|truncatechars:37 }}
                            {% endif %}
                        {% endif %}
        </div>
        <div class="row-header-cell-control" id="ORHC_{{ matrix_cell.id }}" draggable="true" ondragstart="drag(event)">
          <div class="bench-dropdown" id="ORHC_{{ matrix_cell.id }}" draggable="true" ondragstart="drag(event)">
            <button class="bench-drop-button"><i class="fas fa-bars"></i></button>
            <div class="bench-dropdown-content">
						{% if updateBoolean %}
			  <a data-value="{{ matrix_cell.id }}" href="#" class="bench-cell-header-button btn btn-primary"><i class="fa fa-info"></i> View Row Header</a>
			  <a href="{% url 'header_update' matrix.id matrix_cell.id %}" onclick="open_header_edit_dialog(event, 'Updating Bench CPW:{{ matrix_cell.matrix_id|stringformat:"06d" }}, Header Cell:{{ matrix_cell.id }} ... ...'); return false;"><i class="fa fa-edit"></i> Edit Row Header</a>
			  <a href="{% url 'add_row_above' matrix.id forloop.parentloop.counter0	%}"><i class="fa fa-angle-up"></i><span class="menu-item">&#9;</span>Add Row Above</a>
			  <a href="{% url 'delete_this_row' matrix.id forloop.parentloop.counter0 %}" onclick="return confirm('Are you sure you want to DELETE this ROW?')"><i class="fa fa-trash-alt"></i><span class="menu-item">&#9;</span>Delete This Row</a>
		      <a href="{% url 'add_row_below' matrix.id forloop.parentloop.counter0 %}"><i class="fa fa-angle-down"></i><span class="menu-item">&#9;</span>Add Row Below</a>
						{% endif %}
            </div><!-- End of bench-dropdown-content -->
          </div><!-- End of bench-dropdown -->
        </div><!-- End of row-header-cell-control -->
      </div><!-- End of row-header-cell -->
    </div><!-- End of flex-bench-item -->
		    	    {% endif %}
			    {% endif %}
<!-- Column Header Cells -->
			    {% if not matrix_cell.is_column_header and matrix_cell.is_row_header %}
<!-- The Right-Most Column Header Cell -->
    			    {% if matrix.get_max_column == matrix_cell.xcoordinate %}
    <div class="flex-bench-item" id="RMCHC_{{ matrix_cell.id }}">
      <div class="column-header-right-cell" id="RMCHC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
      </div><!-- End of column-header-right-cell -->
    </div><!-- End of flex-bench-item -->
				    {% endif %}
<!-- The Other Column Header Cells -->
				    {% if matrix.get_max_column != matrix_cell.xcoordinate %}
    <div class="flex-bench-item" id="OCHC_{{ matrix_cell.id }}" draggable="true" ondragstart="drag(event)">
						{% csrf_token %}
      <div class="column-header-cell" style="width:{{ matrix.width }}px;" id="OCHC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
        <div class="column-header-cell-title" style="width:{{ matrix.width|add:"-62"  }}px;" id="OCHC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
                        {% if matrix_cell.title != '' %}
          <div class="tooltipcolumn"><i class="fa fa-info-circle"></i>
                            {% if matrix.width >= 75 and matrix.width <= 93 %}
                            {% endif %}
                            {% if matrix.width >= 94 and matrix.width <= 112 %}
                            {% endif %}
                            {% if matrix.width >= 113 and matrix.width <= 131 %}
            {{ matrix_cell.title|truncatechars:2 }}
                            {% endif %}
                            {% if matrix.width >= 132 and matrix.width <= 150 %}
            {{ matrix_cell.title|truncatechars:4 }}
                            {% endif %}
                            {% if matrix.width >= 151 and matrix.width <= 169 %}
            {{ matrix_cell.title|truncatechars:5 }}
                            {% endif %}
                            {% if matrix.width >= 170 and matrix.width <= 188 %}
            {{ matrix_cell.title|truncatechars:7 }}
                            {% endif %}
                            {% if matrix.width >= 189 and matrix.width <= 208 %}
            {{ matrix_cell.title|truncatechars:9 }}
                            {% endif %}
                            {% if matrix.width >= 209 and matrix.width <= 227 %}
            {{ matrix_cell.title|truncatechars:12 }}
                            {% endif %}
                            {% if matrix.width >= 228 and matrix.width <= 246 %}
            {{ matrix_cell.title|truncatechars:14 }}
                            {% endif %}
                            {% if matrix.width >= 247 and matrix.width <= 265 %}
            {{ matrix_cell.title|truncatechars:17 }}
                            {% endif %}
                            {% if matrix.width >= 266 and matrix.width <= 284 %}
            {{ matrix_cell.title|truncatechars:19 }}
                            {% endif %}
                            {% if matrix.width >= 285 and matrix.width <= 303 %}
            {{ matrix_cell.title|truncatechars:23 }}
                            {% endif %}
                            {% if matrix.width >= 304 and matrix.width <= 322 %}
            {{ matrix_cell.title|truncatechars:24 }}
                            {% endif %}
                            {% if matrix.width >= 323 and matrix.width <= 341 %}
            {{ matrix_cell.title|truncatechars:26 }}
                            {% endif %}
                            {% if matrix.width >= 342 and matrix.width <= 360 %}
            {{ matrix_cell.title|truncatechars:29 }}
                            {% endif %}
                            {% if matrix.width >= 361 and matrix.width <= 379 %}
            {{ matrix_cell.title|truncatechars:31 }}
                            {% endif %}
                            {% if matrix.width >= 380 and matrix.width <= 398 %}
            {{ matrix_cell.title|truncatechars:33 }}
                            {% endif %}
                            {% if matrix.width >= 399 and matrix.width <= 407 %}
            {{ matrix_cell.title|truncatechars:36 }}
                            {% endif %}
                            {% if matrix.width >= 408 and matrix.width <= 426 %}
            {{ matrix_cell.title|truncatechars:37 }}
                            {% endif %}
                            {% if matrix.width >= 427 and matrix.width <= 450 %}
            {{ matrix_cell.title|truncatechars:39 }}
                            {% endif %}
            <span class="tooltipcolumntext">{{ matrix_cell.title }}</span>
          </div>
                        {% endif %}
	  	</div><!-- End of column-header-cell-title -->
        <div class="column-header-cell-control" id="OCHC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
          <div class="bench-dropdown" id="OCHC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
            <button class="bench-drop-button"><i class="fas fa-bars"></i></button>
            <div class="bench-dropdown-content">
						{% if updateBoolean %}
			  <a data-value="{{ matrix_cell.id }}" href="#" class="bench-cell-header-button btn btn-primary"><i class="fa fa-info"></i> View Column Header</a>
			  <a href="{% url 'header_update' matrix.id matrix_cell.id %}" onclick="open_header_edit_dialog(event, 'Updating Bench CPW:{{ matrix_cell.matrix_id|stringformat:"06d" }}, Header Cell:{{ matrix_cell.id }} ... ...'); return false;"><i class="fa fa-edit"></i> Edit Column Header</a>
			  <a href="{% url 'add_column_left' matrix.id forloop.counter0	%}"><i class="fa fa-angle-left"></i><span class="menu-item">&#9;</span>Add Column Left</a>
			  <a href="{% url 'delete_this_column' matrix.id forloop.counter0 %}" onclick="return confirm('Are you sure you want to DELETE this COLUMN?')"><i class="fa fa-trash-alt"></i><span class="menu-item">&#9;</span>Delete This Column</a>
              <a href="{% url 'add_column_right' matrix.id forloop.counter0 %}"><i class="fa fa-angle-right"></i><span class="menu-item">&#9;</span>Add Column Right</a>
						{% endif %}
            </div><!-- End of bench-dropdown-content -->
          </div><!-- End of bench-dropdown -->
        </div><!-- End of column-header-cell-control -->
      </div><!-- End of column-header-cell -->
    </div><!-- End of flex-bench-item -->
			        {% endif %}
			    {% endif %}
<!-- Non Header Cells -->
			    {% if not matrix_cell.is_column_header and not matrix_cell.is_row_header %}
<!-- Ordinary Cells -->
    			    {% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
						{% if updateBoolean %}
	<div class="flex-bench-item" id="cell_{{ matrix_cell.id }}" draggable="true" ondragstart="drag(event)">
							{% csrf_token %}
						{% else %}
	<div class="flex-bench-item" id="cell_{{ matrix_cell.id }}">
						{% endif %}
	  <div class="cell" id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width }}px; height:{{ matrix.height }}px;" ondrop="drop(event)" ondragover="allowDrop(event)" >
        <div id="cell_{{ matrix_cell.id }}" class="cell-title" style="font-size: 12px; width:{{ matrix.width|add:"-62" }}px;">
                        {% if matrix_cell.title != ''%}
		  <div class="tooltip" style="font-size: 12px;">
          <!-- <div class="tooltip" style="font-size: 12px; width:{{ matrix.width|add:"-82" }}px;"> -->

                            {% if matrix.width >= 75 and matrix.width <= 93 %}
      		  {{ matrix_cell.title|truncatechars:1 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 94 and matrix.width <= 112 %}
      		  {{ matrix_cell.title|truncatechars:1 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 113 and matrix.width <= 131 %}
      		  {{ matrix_cell.title|truncatechars:3 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 132 and matrix.width <= 150 %}
      		  {{ matrix_cell.title|truncatechars:5 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 151 and matrix.width <= 169 %}
      		  {{ matrix_cell.title|truncatechars:9 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 170 and matrix.width <= 188 %}
      		  {{ matrix_cell.title|truncatechars:11 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 189 and matrix.width <= 208 %}
      		  {{ matrix_cell.title|truncatechars:13 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 209 and matrix.width <= 227 %}
      		  {{ matrix_cell.title|truncatechars:15 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 228 and matrix.width <= 246 %}
      		  {{ matrix_cell.title|truncatechars:17 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 247 and matrix.width <= 265 %}
      		  {{ matrix_cell.title|truncatechars:19 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 266 and matrix.width <= 284 %}
      		  {{ matrix_cell.title|truncatechars:21 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 285 and matrix.width <= 303 %}
      		  {{ matrix_cell.title|truncatechars:23 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 304 and matrix.width <= 322 %}
      		  {{ matrix_cell.title|truncatechars:25 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 323 and matrix.width <= 341 %}
      		  {{ matrix_cell.title|truncatechars:28 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 342 and matrix.width <= 360 %}
      		  {{ matrix_cell.title|truncatechars:31 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 361 and matrix.width <= 379 %}
      		  {{ matrix_cell.title|truncatechars:34 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 380 and matrix.width <= 398 %}
      		  {{ matrix_cell.title|truncatechars:37 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 399 and matrix.width <= 407 %}
      		  {{ matrix_cell.title|truncatechars:40 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 408 and matrix.width <= 426 %}
      		  {{ matrix_cell.title|truncatechars:43 }}
      		  				{% endif %}
      		  				{% if matrix.width >= 427 and matrix.width <= 450 %}
      		  {{ matrix_cell.title|truncatechars:43 }}
      		  				{% endif %}

    	    <!-- <span class="tooltiptext" style="margin-left: -{{ matrix.width|add:"-82" }}px;">{{ matrix_cell.title }}</span> -->
            <span class="tooltiptext">{{ matrix_cell.title }}</span>
    	  </div>
                            {% if matrix_cell.image %}
                                {% if matrix_cell.image.exists_parent_image_links or matrix_cell.image.exists_child_image_links %}
		  <div id="cell_{{ matrix_cell.id }}" class="cell-control-chain" style="left: {{ matrix.width|add:"-62" }}px;">
	  	    <a href="{% url 'view_a_and_b_image_links' matrix_cell.image.id %}"><i class="fa fa-chain fa-sm"></i></a>
          </div>
						        {% endif %}
                            {% endif %}
                        {% endif %}
        </div><!-- End of cell-title -->
        <div id="cell_{{ matrix_cell.id }}" class="cell-control">
          <div id="cell_{{ matrix_cell.id }}" class="cell-dropdown">
            <button class="cell-drop-button"><i class="fas fa-bars"></i></button>
            <div class="cell-dropdown-content">
    					{% if readBoolean %}
			  <a data-value="{{ matrix_cell.id }}" href="#" class="bench-cell-blog-button btn btn-primary"><i class="fa fa-eye"></i> View Cell Commentary</a>
			  				{% if updateBoolean %}
			  					{% if matrix_cell.has_image %}
			  <a href="{% url 'view_cell_blog' matrix.id matrix_cell.id %}" target="_blank"><i class="fa fa-edit"></i><span class="menu-item">&#9;</span>Edit Cell Commentary</a>
			  <a href="{% url 'amend_cell' matrix.id matrix_cell.id %}"><i class="fa fa-pencil-alt"></i><span class="menu-item">&#9;</span>Edit Cell</a>
			  <a href="{% url 'clear_cell' matrix.id matrix_cell.id view_matrix %}" onclick="return confirm('Are you sure you want to CLEAR this CELL?')"><i class="fa fa-trash"></i><span class="menu-item">&#9;</span>Clear Cell</a>
								{% else %}
			  <a href="{% url 'amend_cell' matrix.id matrix_cell.id %}"><i class="fa fa-pencil-alt"></i><span class="menu-item">&#9;</span>Edit Cell</a>
			  					{% endif %}
			  				{% endif %}
		    			{% endif %}
            </div><!-- End of cell-dropdown-content -->
          </div><!-- End of cell-dropdown -->
        </div><!-- End of cell-control -->
        <div id="cell_{{ matrix_cell.id }}" class="cell-body" style="width:{{ matrix.width|add:"-6" }}px; height:{{ matrix.height|add:"-32" }}px;">
						{% if matrix_cell.image %}
							{% if matrix_cell.image.roi == 0 %}
		  						{% if matrix_cell.image.server.is_accessible %}
				  					{% if request.get_host == 'localhost:8000' %}
		  <div id="I_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_out">
		    <a href="https://{{ matrix_cell.image.server.url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		  </div>
		  <div id="O_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_in">
			<a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
			  <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
			</a>
		  </div>
						  			{% else %}
		  <div id="I_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_out">
		    <a href="https://{{ matrix_cell.image.server.url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		  </div>
		  <div id="O_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_in">
		    <a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
			  <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
			</a>
		  </div>
						  			{% endif %}
						  		{% else %}
		  <a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
		    <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
		  </a>
						  		{% endif %}
						  	{% else %}
						  		{% if matrix_cell.image.server.is_accessible %}
						  			{% if request.get_host == 'localhost:8000' %}
		  <div id="I_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_out">
		    <a href="https://{{ matrix_cell.image.server.url_server }}/webclient/login/?url=http://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		  </div>
		  <div id="O_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_in">
		    <a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
			  <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
			</a>
		  </div>
						  			{% else %}
		  <div id="I_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_out">
		    <a href="https://{{ matrix_cell.image.server.url_server }}/webclient/login/?url=https://{{ request.get_host }}{% url 'matrix' matrix.id %}"><button class="button button-add"><i class="fa fa-sign-in-alt"></i></button></a>
		  </div>
		  <div id="O_{{ matrix_cell.id }}_{{ matrix_cell.image.server.uid }}@{{ matrix_cell.image.server.url_server }}" class="loginStatus_in">
		    <a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
			  <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
			</a>
		  </div>
						  			{% endif %}
						  		{% else %}
		  <a id="cell_{{ matrix_cell.id }}" class="cell-image" href="{{ matrix_cell.image.viewer_url }}" target="_blank">
		    <img id="cell_{{ matrix_cell.id }}" style="width:{{ matrix.width|add:"-42" }}px; height:{{ matrix.height|add:"-42" }}px;" alt="{{ matrix_cell.image.name }}" title="{{ matrix_cell.image.name }}" src="{{ matrix_cell.image.birdseye_url }}">
		  </a>
								{% endif %}
							{% endif %}
						{% endif %}
        </div><!-- End of cell-body -->
      </div><!-- End of cell -->
    </div><!-- End of flex-bench-item -->
				    {% endif %}
<!-- Right-Most Footer Cells -->
				    {% if matrix.get_max_column == matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
    <div class="flex-bench-item" id="RMFC_{{ matrix_cell.id }}">
						{% csrf_token %}
      <div class="row-footer-cell" style="height:{{ matrix.height }}px;" id="RMFC_{{ matrix_cell.id }}" ondrop="dropCol(event)" ondragover="allowColDrop(event)">
      </div><!-- bottom-right-cell -->
    </div><!-- End of flex-bench-item -->
				    {% endif %}
<!-- Bottom-Most Footer Cells -->
				    {% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row == matrix_cell.ycoordinate %}
    <div class="flex-bench-item" id="BMFC_{{ matrix_cell.id }}">
						{% csrf_token %}
      <div class="column-footer-cell" style="width:{{ matrix.width }}px;" id="BMFC_{{ matrix_cell.id }}" ondrop="dropRow(event)" ondragover="allowRowDrop(event)">
      </div><!-- column-footer-cell -->
    </div><!-- End of flex-bench-item -->
				    {% endif %}
<!-- Bottom-Most and Right-Most Footer Cell -->
				    {% if matrix.get_max_column == matrix_cell.xcoordinate and matrix.get_max_row == matrix_cell.ycoordinate %}
    <div class="flex-bench-item" id="BMRMFC_{{ matrix_cell.id }}">
						{% csrf_token %}
      <div class="bottom-right-cell" id="BMRMFC_{{ matrix_cell.id }}" ondrop="dropRow(event)" ondragover="allowRowDrop(event)">
      </div><!-- bottom-right-cell -->
    </div><!-- End of flex-bench-item -->
				    {% endif %}
			    {% endif %}
		    {% endwith %}
	    {% endfor %}
  </div><!-- End of flex-bench-container -->
    {% endfor %}
<!-- There are NO Cells - This should not happen! -->
{% else %}
{% endif %}
</div><!-- End of page-content -->
</div><!-- End of page-body -->

{% endblock %}

{% block extrajs %}

<script type="text/javascript">

	function confirmation(question, source_type) {

		var defer = $.Deferred();

		if (source_type == "cell") {

			$('<div></div>')
				.html(question)
				.dialog({
					autoOpen: true,
					modal: true,
					title: 'Confirmation',
					buttons: {
						"SWAP": function () {
							defer.resolve("swap");
							$(this).dialog("close");
						},
						"CUT": function () {
							defer.resolve("overwrite");
							$(this).dialog("close");
						},
						"COPY": function () {
							defer.resolve("overwrite_leave");
							$(this).dialog("close");
						},
						"CLOSE": function () {
							$(this).dialog('destroy').remove();
						}
					},
					close: function () {
						$(this).dialog('destroy').remove();
					}
				});

		}

		if (source_type == "image") {

			$('<div></div>')
				.html(question)
				.dialog({
					autoOpen: true,
					modal: true,
					title: 'Confirmation',
					buttons: {
						"IMPORT": function () {
							defer.resolve("move");
							$(this).dialog("close");
						},
						"CLOSE": function () {
							$(this).dialog('destroy').remove();
						}
					},
					close: function () {
						$(this).dialog('destroy').remove();
					}
				});
		}

		return defer.promise();
	}


	function onclick(source, target, source_type){

		var question = "";

	   	if (source_type == "cell") {

			question = "Do you want to SWAP Cells, CUT or COPY the Source Cell to the Target Cell?";
		}

		if (source_type == "image") {

			question = "Do you want to IMPORT this Image to this CELL?";
		}

		//console.log("source_type : " + source_type);

		confirmation(question, source_type).then(function (answer) {

			//console.log("answer : " + answer);

			if (answer == "swap"){

				$.ajax({
					url: '{% url 'swap_cells' %}',
					data: {
							'source': source,
							'target': target,
							'source_type': source_type,
							csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					dataType: 'json',
					type: 'post',
					success: function (data) {
						//console.log("Cell Swap SUCCESS! Source: " + data.source + "  Target: " + data.target);
						if (data.failure) {
							alert("Cell Swap Failed! Source: " + data.source + "  Target: " + data.target);
						}
						window.location.reload();
					}
				});
			}

			if (answer == "overwrite"){

				$.ajax({
					url: '{% url 'overwrite_cell' %}',
					data: {
						'source': source,
						'target': target,
						'source_type': source_type,
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					dataType: 'json',
					type: 'post',
					success: function (data) {
						if (data.failure) {
							alert("Cell Overwrite Failed! Source: " + data.source + "  Target: " + data.target);
						}
						window.location.reload();
					}
				});
			}

			if (answer == "move"){

				$.ajax({
					url: '{% url 'import_image' %}',
					data: {
						'source': source,
						'target': target,
						'source_type': source_type,
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					dataType: 'json',
					type: 'post',
					success: function (data) {
						//console.log("Image Import SUCCESS! Source: " + data.source + "  Target: " + data.target);
						if (data.failure) {
							alert("Image Import Failed! Source: " + data.source + "  Target: " + data.target);
						}
						window.location.reload();
					}
				});

			}

			if (answer == "overwrite_leave"){

				$.ajax({
					url: '{% url 'overwrite_cell_leave' %}',
					data: {
						'source': source,
						'target': target,
						'source_type': source_type,
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
					dataType: 'json',
					type: 'post',
					success: function (data) {
						if (data.failure) {
							alert("Cell Overwrite and Leave Failed! Source: " + data.source + "  Target: " + data.target);
						}
						window.location.reload();
					}
				});
			}
		});
	}


	function allowDrop(ev){
		ev.preventDefault();
	}

	function drag(ev){
		ev.dataTransfer.setData("Text",ev.target.id);
	}

	function drop(ev){

		ev.preventDefault();

		var image_id = '';
		var src = '';

		var image = ev.dataTransfer.getData("text/html")
		var division = ev.dataTransfer.getData("Text")

		//console.log("image : " + image);
		//console.log("division : " + division);

		if ( image ) {

			var dropContext = $('<div>').append(image);
			image_id = $(dropContext).find("img").attr('id');
			src = document.getElementById(image_id);
		}

		if ( division ) {

			src = document.getElementById(division);
		}

		//console.log("src.id : " + src.id);

		var srcParent = src.parentNode;

		var source_array = src.id.split("_",2);
		var source_id = source_array[1];
		var source_type = source_array[0];

		//console.log("source_id : " + source_id);
		//console.log("source_type : " + source_type);

		const data = ev.target;

		//console.log("data : " + data);

		var tgt = ev.target;
		var target_array = tgt.id.split("_",2);
		var target_id = target_array[1];
		var target_type = target_array[0];

		//console.log("target_id : " + target_id);
		//console.log("target_type : " + target_type);

		//ev.currentTarget.replaceChild(src, tgt);
		//srcParent.appendChild(tgt);

		onclick(source_id, target_id, source_type);

	}

	function allowColDrop(ev){
		ev.preventDefault();
	}

	function dragCol(ev){
		ev.dataTransfer.setData("Text",ev.target.id);
	}

	function dropCol(ev){

		ev.preventDefault();
		var src = document.getElementById(ev.dataTransfer.getData("Text"));
		var srcParent = src.parentNode;

		//console.log("dropCol");

		var source_array = src.id.split("_",2);
		var source_id = source_array[1];
		var source_type = source_array[0];
		//console.log("source_id : " + source_id);
		//console.log("source_type : " + source_type);

		var tgt = ev.target;
		var target_array = tgt.id.split("_",2);
		var target_id = target_array[1];
		var target_type = target_array[0];

		//console.log("target_id : " + target_id);
		//console.log("target_type : " + target_type);

		if (source_type == "OCHC" && target_type != "BMRMFC"){

			//console.log("source type Allowed : " + source_type);
			//console.log("target type Allowed : " + target_type);

			$.ajax({
				url: '{% url 'shuffle_columns' %}',
				data: {
					'source': source_id,
					'target': target_id,
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				dataType: 'json',
				type: 'post',
				success: function (data) {
					if (data.failure) {
						alert("Column Shuffle Failed! Source: " + data.source + "  Target: " + data.target);
					}
					window.location.reload();
				}
			});

		} else {

			//console.log("source type NOT Allowed : " + source_type);
			//console.log("target type NOT Allowed : " + target_type);
		}

		if (source_type == "cell" && target_type != "BMRMFC"){

			//console.log("source type Allowed : " + source_type);
			//console.log("target type Allowed : " + target_type);

			$.ajax({
				url: '{% url 'shuffle_columns' %}',
				data: {
					'source': source_id,
					'target': target_id,
					csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				dataType: 'json',
				type: 'post',
				success: function (data) {
					if (data.failure) {
						alert("Column Shuffle Failed! Source: " + data.source + "  Target: " + data.target);
					}
					window.location.reload();
				}
			});

		} else {

			//console.log("source type NOT Allowed : " + source_type);
			//console.log("target type NOT Allowed : " + target_type);
		}
	}

	function allowRowDrop(ev){
		ev.preventDefault();
	}

	function dragRow(ev){
		ev.dataTransfer.setData("Text",ev.target.id);
	}

	function dropRow(ev){

		ev.preventDefault();
		var src = document.getElementById(ev.dataTransfer.getData("Text"));
		var srcParent = src.parentNode;

		//console.log("dropRow");

		var source_array = src.id.split("_",2);
		var source_id = source_array[1];
		var source_type = source_array[0];
		//console.log("source_id : " + source_id);
		//console.log("source_type : " + source_type);

		var tgt = ev.target;
		var target_array = tgt.id.split("_",2);
		var target_id = target_array[1];
		var target_type = target_array[0];

		//console.log("target_id : " + target_id);
		//console.log("target_type : " + target_type);

		if (source_type == "ORHC" && target_type != "BMRMFC"){

			//console.log("source type Allowed : " + source_type);
			//console.log("target type Allowed : " + target_type);

			$.ajax({
				url: '{% url 'shuffle_rows' %}',
				data: {
					'source': source_id,
					'target': target_id,
				  	csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				dataType: 'json',
				type: 'post',
				success: function (data) {
					if (data.failure) {
						alert("Row Shuffle Failed! Source: " + data.source + "  Target: " + data.target);
					}
					window.location.reload();
				}
			});
		} else {

			//console.log("source type NOT Allowed : " + source_type);
			//console.log("target type NOT Allowed : " + target_type);
		}

		if (source_type == "cell" && target_type != "BMRMFC"){

			//console.log("source type Allowed : " + source_type);
			//console.log("target type Allowed : " + target_type);

			$.ajax({
				url: '{% url 'shuffle_rows' %}',
				data: {
					'source': source_id,
					'target': target_id,
				  	csrfmiddlewaretoken: '{{ csrf_token }}'
				},
				dataType: 'json',
				type: 'post',
				success: function (data) {
					if (data.failure) {
						alert("Row Shuffle Failed! Source: " + data.source + "  Target: " + data.target);
					}
					window.location.reload();
				}
			});
		} else {

			//console.log("source type NOT Allowed : " + source_type);
			//console.log("target type NOT Allowed : " + target_type);
		}
	}


	// FUNCTION
	async function makeJSONRequest(method, url, data) {

	    const options = {
	        method: method, // *GET, POST, PUT, DELETE, etc.
	        credentials: 'include', // include, *same-origin, omit
	    }

	    if (method == 'POST') {

	        const csrf_token = getCookie('csrftoken');

	        options.headers = {
	            'x-csrftoken': csrf_token
	        }
	    }

	    if (data) {

	        options.body = data;
	    }

	    // Do the fetch and check status...
	    const response = await fetch(url, options);

	    if (response.status != 200) {

	        throw response;
	    }

	    // If OK, parse JSON response into native JavaScript objects
	    return response.json();
	}


	// FUNCTION
	function getCookie(name) {

	    var cookieValue = null;

	    if (document.cookie && document.cookie != '') {

	        var cookies = document.cookie.split(';');

	        for (var i = 0; i < cookies.length; i++) {

	            var cookie = cookies[i].trim();

	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {

	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}


	// FUNCTION
	function getParameterByName(name, url = window.location.href) {

	    name = name.replace(/[\[\]]/g, '\\$&');

	    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
	        results = regex.exec(url);

	    if (!results) return null;

	    if (!results[2]) return '';

	    return decodeURIComponent(results[2].replace(/\+/g, ' '));
	}


	// FUNCTION
	async function loginStatusPresent(divname) {

	    var projects_url = getUrl('url:projects');

	    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

			console.log("loginStatusPresent : " + divname + " ; display" )

		    document.getElementById(divname).style.display = "display";

	    }).catch(rsp => {

			console.log("loginStatusPresent : " + divname + " ; none" )

			document.getElementById(divname).style.display = "none";
	    });

	}


	// FUNCTION
	async function loginStatusAbsent(divname) {

	    var projects_url = getUrl('url:projects');

	    const data = await makeJSONRequest('GET', projects_url).then(rsp => {

			console.log("loginStatusAbsent : " + divname + " ; none" )

		    document.getElementById(divname).style.display = "none";

	    }).catch(rsp => {

			console.log("loginStatusAbsent : " + divname + " ; display" )

			document.getElementById(divname).style.display = "display";
	    });

	}


	// FUNCTION
	async function server_present(server_url, divname) {

	    // List of supported versions
	    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

	    // Get base_url from last version in the list
	    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
	    latest_base_url = versions[versions.length - 1]["url:base"]

	    // Get the list of top-level urls as starting points,
	    base_urls = await makeJSONRequest('GET', latest_base_url);

	    // Also get CSRF token needed for any POST requests (login, logout etc)
	    // Header of this response sets a cookie. NB: We can ingore the response JSON
	    await makeJSONRequest('GET', getUrl('url:token'));

	    // Try to load Projects (will show Login form if we're not logged in)
	    loginStatusPresent(divname);
	}


	// FUNCTION
	async function server_absent(server_url, divname) {

	    // List of supported versions
	    const versions = await makeJSONRequest('GET', server_url + 'api/').then(rsp => rsp.data);

	    // Get base_url from last version in the list
	    //latest_base_url = versions[versions.length - 1]["url:base"].replace("http", protocol);
	    latest_base_url = versions[versions.length - 1]["url:base"]

	    // Get the list of top-level urls as starting points,
	    base_urls = await makeJSONRequest('GET', latest_base_url);

	    // Also get CSRF token needed for any POST requests (login, logout etc)
	    // Header of this response sets a cookie. NB: We can ingore the response JSON
	    await makeJSONRequest('GET', getUrl('url:token'));

	    // Try to load Projects (will show Login form if we're not logged in)
	    loginStatusAbsent(divname);
	}


	// FUNCTION
	function getUrl(name) {

	    return base_urls[name];
	}


	// MAINLINE

	// When page first loads, if we have a server...
	//const server_url = getParameterByName("server");

	collection_in = document.getElementsByClassName("loginStatus_in");

	for (var i = 0; i < collection_in.length; i++) {

		nodeHTML = collection_in[i];
		text = nodeHTML.id;
		//console.log("IN text : " + text);
		myArray = text.split("@");
		server_url = 'https://' + myArray[1] + '/';

		server_present(server_url, nodeHTML.id);
	}

	collection_out = document.getElementsByClassName("loginStatus_out");

	for (var i = 0; i < collection_out.length; i++) {

		nodeHTML = collection_out[i]
		text = nodeHTML.id;
		//console.log("OUT text : " + text);
		myArray = text.split("@");
		server_url = 'https://' + myArray[1] + '/';

		server_absent(server_url, nodeHTML.id);
	}


	function open_matrix_edit_dialog(event, title) {
	  event.preventDefault();
	  var url = $(event.target).attr('href');
	  dialog_edit.options.url = url;
	  dialog_edit.options.title = '<i class="fa fa-calculator"></i> ' + title;
	  dialog_edit.open(event);
	}

	function open_header_edit_dialog(event, title) {
	  event.preventDefault();
	  var url = $(event.target).attr('href');
	  dialog_edit.options.url = url;
	  dialog_edit.options.title = '<i class="fa fa-calculator"></i> ' + title;
	  dialog_edit.open(event);
	}

	function delete_matrix(event, title) {
	  event.preventDefault();
	  var url = $(event.target).attr('href');
	  FrontendForms.confirmRemoteAction(
	    url, {
	      title: title,
	      text: 'Are you sure?',
	      confirmButtonClass: 'btn-danger',
	      icon: 'question'
	    },
	    function (data) {
	      Swal.fire({
	        text: 'Bench "' + data.object_id + '" has been deleted',
	        icon: 'warning'
	      })
		  var url = "{% url 'list_benches' %}"
		  FrontendForms.gotourl(url, show_layer=true);
	    },
	    data = true // set to any value to obtain POST
	  );
	}


	$(document).ready(function () {
	  dialog_edit = new Dialog({
	    dialog_selector: '#dialog_generic',
	    html: '<h1>Loading ...</h1>',
	    width: '600px',
	    min_height: '200px',
	    button_save_initially_hidden: true,
	    enable_trace: true,
	    callback: function (event_name, dialog, params) {
	      switch (event_name) {
	        case "submitting":
	          FrontendForms.overlay_show('.dialog-body');
	          break;
	        case "loaded":
	          FrontendForms.overlay_hide('.dialog-body');
	          break;
	        case "submitted":
	          var object_id = dialog.element.find('input[name=object_id]').val();
	          // Reload page, with last selection enhanced
	          var url = new URL(document.location.href);
	          url.searchParams.set('selected_record', object_id);
	          FrontendForms.gotourl(url, show_layer=true);
	          break;
	      }
	    }
	  });
	});


    function onBenchInfoButtonClicked(event) {
        event.preventDefault();
        var n = $(event.target).data('value');
        var dialogs = [
        	dialog_info_{{ matrix.id }}
        ];
        var target = "dialog_info_" + n.toString();
        eval(target).open(event);
	}

    $(document).ready(function() {
        $('.bench-info-button').on('click', onBenchInfoButtonClicked);
        dialog_info_{{ matrix.id }} = new Dialog({
            url: "{% url 'bench_read' matrix.id %}",
            dialog_selector: '#dialog_generic',
            html: '<h1>Loading ...</h1>',
            width: '600px',
            min_height: '200px',
            title: '<i class="fa fa-calculator"></i> Info. for Bench CPW:{{ matrix.id|stringformat:"06d" }} ...',
            button_save_label: null,
            enable_trace: true
        });
    });


	function onBenchBlogButtonClicked(event) {
        event.preventDefault();
        var n = $(event.target).data('value');
        var dialogs = [
            dialog_blog_{{ matrix.id }}
        ];
        var target = "dialog_blog_" + n.toString();
        eval(target).open(event);
	}

    $(document).ready(function() {
        $('.bench-blog-button').on('click', onBenchBlogButtonClicked);
        dialog_blog_{{ matrix.id }} = new Dialog({
            url: "{% url 'bench_blog_read' matrix.id %}",
            dialog_selector: '#dialog_generic',
            html: '<h1>Loading ...</h1>',
            width: '600px',
            min_height: '200px',
            title: '<i class="fa fa-calculator"></i> Commentary for Bench CPW:{{ matrix.id|stringformat:"06d" }} ...',
            button_save_label: null,
            enable_trace: true
        });
    });


	function onCellBlogButtonClicked(event) {
        event.preventDefault();
        var n = $(event.target).data('value');
		var dialogs = [
{% if rows %}
    {% for row in rows %}
        {% for column in columns %}
		    {% with matrix_cell=matrix_cells|index:forloop.parentloop.counter0|index:forloop.counter0 %}
  			    {% if not matrix_cell.is_column_header and not matrix_cell.is_row_header %}
    			    {% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
						{% if matrix_cell.has_blogpost %}
            dialog_cell_blog_{{ matrix_cell.id }},
						{% endif %}
				    {% endif %}
  			    {% endif %}
		    {% endwith %}
	    {% endfor %}
    {% endfor %}
{% endif %}
		];
		var target = "dialog_cell_blog_" + n.toString();
		eval(target).open(event);
	}

	$(document).ready(function() {
        $('.bench-cell-blog-button').on('click', onCellBlogButtonClicked);
{% if rows %}
    {% for row in rows %}
        {% for column in columns %}
		    {% with matrix_cell=matrix_cells|index:forloop.parentloop.counter0|index:forloop.counter0 %}
  			    {% if not matrix_cell.is_column_header and not matrix_cell.is_row_header %}
    			    {% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
						{% if matrix_cell.has_blogpost %}
        dialog_cell_blog_{{ matrix_cell.id }} = new Dialog({
            url: "{% url 'bench_cell_blog_read' matrix_cell.id %}",
            dialog_selector: '#dialog_generic',
            html: '<h1>Loading ...</h1>',
            width: '600px',
            min_height: '200px',
            title: '<i class="fa fa-calculator"></i> Bench CPW:{{ matrix_cell.matrix_id|stringformat:"06d" }}, Cell:{{ cell.id }} ...',
            button_save_label: null,
            enable_trace: true
        });
						{% endif %}
				    {% endif %}
  			    {% endif %}
		    {% endwith %}
	    {% endfor %}
    {% endfor %}
{% endif %}
	});

	function onHeaderInfoButtonClicked(event) {
        event.preventDefault();
        var n = $(event.target).data('value');
		var dialogs = [
{% if rows %}
    {% for row in rows %}
        {% for column in columns %}
		    {% with matrix_cell=matrix_cells|index:forloop.parentloop.counter0|index:forloop.counter0 %}
				{% if not matrix_cell.is_master %}
  			    	{% if matrix_cell.is_column_header or matrix_cell.is_row_header %}
    			    	{% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
            dialog_cell_header_{{ matrix_cell.id }},
				    	{% endif %}
					{% endif %}
  			    {% endif %}
		    {% endwith %}
	    {% endfor %}
    {% endfor %}
{% endif %}
		];
		var target = "dialog_cell_header_" + n.toString();
		eval(target).open(event);
	}

	$(document).ready(function() {
        $('.bench-cell-header-button').on('click', onHeaderInfoButtonClicked);
{% if rows %}
    {% for row in rows %}
        {% for column in columns %}
		    {% with matrix_cell=matrix_cells|index:forloop.parentloop.counter0|index:forloop.counter0 %}
				{% if not matrix_cell.is_master %}
  			    	{% if matrix_cell.is_column_header or matrix_cell.is_row_header %}
    			    	{% if matrix.get_max_column != matrix_cell.xcoordinate and matrix.get_max_row != matrix_cell.ycoordinate %}
        dialog_cell_header_{{ matrix_cell.id }} = new Dialog({
            url: "{% url 'header_read' matrix_cell.matrix_id matrix_cell.id %}",
            dialog_selector: '#dialog_generic',
            html: '<h1>Loading ...</h1>',
            width: '600px',
            min_height: '200px',
            title: '<i class="fa fa-calculator"></i> Bench CPW:{{ matrix_cell.matrix_id|stringformat:"06d" }}, Header Cell:{{ matrix_cell.id }} ...',
            button_save_label: null,
            enable_trace: true
        });
						{% endif %}
				    {% endif %}
  			    {% endif %}
		    {% endwith %}
	    {% endfor %}
    {% endfor %}
{% endif %}
	});

</script>

{% endblock extrajs %}
